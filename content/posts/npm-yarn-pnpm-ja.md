+++
title = 'npm/yarn ã®ä¸è¶³ç‚¹ã¨ pnpm ã‚’æ¨ã™ç†ç”±(Japanese)'
date = 2021-12-06T11:46:46+09:00
description = 'npm vs yarn vs pnpm in Japanese'
+++

## pnpmã¨ã¯

[pnpm](https://pnpm.io/) å…¬å¼ã‚µã‚¤ãƒˆã«ã‚ˆã‚‹ã¨ã€pnpmã¯performant npmã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
> Fast, disk space efficient package manager

ãªã®ã§ã€pnpmã¯npm/yarnåŒã˜ã‚ˆã†ãªå­˜åœ¨ã§ã™ã€‚ç¾åœ¨ï¼ˆ2021å¹´12æœˆï¼‰ã€ãŸãã•ã‚“ãƒ¡ã‚¸ãƒ£ãƒ¼ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ[vue](https://github.com/vuejs/vue-next)ã€[prisma](https://github.com/prisma/prisma)...ï¼‰ã¯ pnpmã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚æœ¬æ–‡ã¯npm/yarnã®ä¸è¶³ç‚¹ã€ã¨pnpmã¯ã©ã£ã‚„ã£ã¦è§£æ±ºã—ãŸã®ã‹ã¤ã„ã«ã¦è©³ç´°ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

## çµè«–

npm/yarn - ä¸è¶³ç‚¹

- ãƒ•ãƒ©ãƒƒãƒˆã®node_modulesæ§‹é€ ã¯ã€å¼•ç”¨ã—ã¦ã„ãªã„ä»»æ„ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ã€‚
- é•ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…±æœ‰ã§ããªãã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡æ¶ˆè€—ã«ãªã‚‹ã€‚
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ã„ã€node_modulesã«é‡è¤‡ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚ã‚‹ã€‚

pnpm - è§£æ±ºæ³•

- ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ç”¨ã„ç‹¬è‡ªã®node_modulesæ§‹é€ ã‚’ä½¿ç”¨ã—ã¦ã€package.jsonã«ã‚ã‚‹ã‚‚ã®ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ï¼ˆå³æ ¼ï¼‰ã€‚
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã•ã‚Œã€ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ã‚»ãƒ¼ãƒ–ï¼ˆåŠ¹ç‡çš„ï¼‰ã€‚
- ä¸Šè¨˜ã®å¯¾å¿œã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚æ—©ããªã‚‹ï¼ˆé€Ÿã„ï¼‰ã€‚

å³æ ¼ã€åŠ¹ç‡çš„ã€é€Ÿã„ã¨ãƒ¢ãƒãƒªãƒã‚µãƒãƒ¼ãƒˆã‚‚å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã€pnpmã®ç‰¹å¾´ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã€npm8ã¨yarnã‚‚ãƒ¢ãƒãƒªãƒã‚µãƒãƒ¼ãƒˆãªã®ã§ã€ä¸€å¿œä¸è¶³ç‚¹ã ã¨è€ƒãˆã¦ã„ãªã„ã§ã™ã€‚pnpmã®ãƒ¢ãƒãƒªãƒã‚’ã‚µãƒãƒ¼ãƒˆã¯æœ€å¾Œã§å°‘ã—è©±ã—ã¾ã™ã€‚

## ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹

### npm/yarn - ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ¶ˆè€—ã®node_modules

npm/yarnã¯ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä½¿ã„ã™ãã¨ã„ã†ä¸è¶³ç‚¹ãŒã‚ã£ã¦ã€åŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’100å›åˆ†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€100åˆ†ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒnode_modulesã®ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚æ—¥å¸¸ã®ä¾‹ã§ã¯ã€å‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒçµ‚ã‚ã£ã¦ã€node_modulesãŒãã®ã¾ã¾æ®‹ã£ã¦ã—ã¾ã£ãŸã‚‰ã€å¤§é‡ã®ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ä½¿ã†ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€[npkill](https://npkill.js.org/)ãŒã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚

```shell
$ npx npkill
```
ã§ç¾åœ¨ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã§å…¨ã¦ã®node_modulesã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€å‹•çš„ã§å‰Šé™¤ã§ãã¾ã™ã€‚

### pnpm - åŠ¹ç‡çš„ãªãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹

ä¸€æ–¹ã€pnpmã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åŒä¸€ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆcontent-addressable storeï¼‰ã«ä¿å­˜ã—ã¦ã€åŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åŒã˜ã°ã‚¸ãƒ§ãƒ³ã‚’å†åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œã‚‹ã ã‘ã§ã™ã€‚MacOsãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã¯~/.pnpm-storeã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã‚‚ã€åŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é•ã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å·®åˆ†ã ã‘ãŒæ–°ãŸã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãã†ã—ãŸã‚‰ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ™‚ã«ã€storeã«ã‚ã£ãŸã‚‰ã€å†åˆ©ç”¨ã€ãªã‘ã‚Œã°ã€ãƒ€ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦storeã«ä¿å­˜ã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚

ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½¿ã£ã¦ã€ã§ããŸã“ã¨ã¯

- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒéå¸¸ã«é«˜é€Ÿ([ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯](https://pnpm.io/benchmarks)ã§yarnã®[pnpãƒ¢ãƒ¼ãƒ‰](https://classic.yarnpkg.com/en/docs/pnp/)ã‚ˆã‚Šæ—©ã„)
- ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¯€ç´„

ä»¥ä¸‹ã¯expressã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã“ã¨ãŒã‚ã‚‹ãƒ‘ã‚½ã‚³ãƒ³ã§å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ™‚ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã§ã™ã€‚ã¤ã„ã§ã«ã€npm/yarnã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚‚è²¼ã£ã¦ãŠãã¾ã™ã€‚

pnpm

```
$ pnpm i express
Packages: +52
++++++++++++++++++++++++++++++++++++++++++++++++++++
Progress: resolved 52, reused 52, downloaded 0, added 0, done

dependencies:
+ express 4.17.1
```

npm

```
$ npm i express
npm WARN npm@1.0.0 No description
npm WARN npm@1.0.0 No repository field.

+ express@4.17.1
added 50 packages from 37 contributors and audited 50 packages in 4.309s
found 0 vulnerabilities
```

yarn

```
$ yarn add express
yarn add v1.22.11
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...

success Saved lockfile.
success Saved 29 new dependencies.
info Direct dependencies
â””â”€ express@4.17.1
info All dependencies
â”œâ”€ accepts@1.3.7
â”œâ”€ array-flatten@1.1.1
â”œâ”€ body-parser@1.19.0
â”œâ”€ content-disposition@0.5.3
â”œâ”€ cookie-signature@1.0.6
â”œâ”€ cookie@0.4.0
â”œâ”€ destroy@1.0.4
â”œâ”€ ee-first@1.1.1
â”œâ”€ express@4.17.1
â”œâ”€ finalhandler@1.1.2
â”œâ”€ forwarded@0.2.0
â”œâ”€ inherits@2.0.3
â”œâ”€ ipaddr.js@1.9.1
â”œâ”€ media-typer@0.3.0
â”œâ”€ merge-descriptors@1.0.1
â”œâ”€ methods@1.1.2
â”œâ”€ mime-db@1.51.0
â”œâ”€ mime@1.6.0
â”œâ”€ ms@2.0.0
â”œâ”€ negotiator@0.6.2
â”œâ”€ path-to-regexp@0.1.7
â”œâ”€ proxy-addr@2.0.7
â”œâ”€ raw-body@2.4.0
â”œâ”€ safer-buffer@2.1.2
â”œâ”€ serve-static@1.14.1
â”œâ”€ type-is@1.6.18
â”œâ”€ unpipe@1.0.0
â”œâ”€ utils-merge@1.0.1
â””â”€ vary@1.1.2
âœ¨  Done in 1.14s.
```

pnpmã¯ã©ã®ãã‚‰ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†åˆ©ç”¨ã‹ã€æ–°ã—ããƒ€ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‹ã™ãåˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã®ã‚ã‹ã‚Šã‚„ã™ã•ã¨è¨€ã£ã¦ã‚‚å°‘ã—å‹ã¤ã‹ãªã¨æ€ã„ã¾ã™ã­ã€‚


## node_modulesã®æ§‹é€ ã¨ä¾å­˜é–¢ä¿‚ã®è§£æ±º

ã“ã‚Œã‹ã‚‰ã¯åŒã˜ã‚·ãƒ³ãƒ—ãƒ«ã®ä¾‹ï¼šbarã«ä¾å­˜ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸fooã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã„ã†ã‚·ãƒ¼ãƒ³ã‚’è€ƒãˆã¦ãã ã•ã„ã€‚
npm/yarnã¯ç¾åœ¨ã®å½¢ã«ãªã‚‹ã¾ã§3å›å¤§ããªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚pnpmã®æ”¹å–„ç‚¹ã‚’ç†è§£ã™ã‚‹ãŸã‚ã€1ã¤ã¥ã¤è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### npm1 - ãƒã‚¹ãƒˆã•ã‚Œã‚‹node_modules

fooã¯barã«ä¾å­˜ã™ã‚‹ã®ã§ã€ä¸€ç•ªå˜ç´”ã®è€ƒãˆæ–¹ã§ã¯barã¯fooã®node_modulesã«å…¥ã‚Œã‚Œã°ã„ã„ã§ã™ã­ã€‚
npm1ã‚‚åŒã˜è€ƒãˆæ–¹ãªã®ã§ã€ã“ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã‚Šã¾ã™ã€‚
```
.
â””â”€â”€ node_modules
    â””â”€â”€ foo
        â”œâ”€â”€ index.d.ts
        â”œâ”€â”€ package.json
        â””â”€â”€ node_modules
            â””â”€â”€ bar
                â”œâ”€â”€ index.js
                â””â”€â”€ package.json
```

ã‚‚ã—barã¯ä»–ã®ä¾é ¼ä¾‹ãˆã°lodashãŒã‚ã‚Œã°ã€barã®node_modulesã«å…¥ã£ã¦ã€nested node_modulesã¨è¨€ã„ã¾ã™ã€‚ã§ã¯ã€ã“ã®æ§‹é€ ã¯ã©ã®ã‚ˆã†ãªå•é¡Œç‚¹ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```
.
â””â”€â”€ node_modules
    â””â”€â”€ foo
        â”œâ”€â”€ index.js
        â”œâ”€â”€ package.json
        â””â”€â”€ node_modules
            â””â”€â”€ bar
                â”œâ”€â”€ index.js
                â”œâ”€â”€ package.json
                â””â”€â”€ node_modules
                    â””â”€â”€ lodash
                        â”œâ”€â”€ index.js
                        â””â”€â”€ package.json
```

ãã†ã§ã™ã€‚ã“ã‚Œã¯ç„¡é™ã«nestedã«ãªã‚ŠãŒã¡ã§ã™ã€‚æ·±ã™ãã‚‹æ§‹é€ ã«ãªã£ãŸã‚‰ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚

- ãƒ‘ã‚¹ãŒé•·ã™ãã¦ã€windowsã®ãƒ‘ã‚¹é•·ã•ã®åˆ¶é™ã‚’è¶…ãˆã¦ã—ã¾ã„ã¾ã™ã€‚
- é‡è¤‡ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¤§é‡ç™ºç”Ÿã€‚ä»®ã«fooã¨barãŒåŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®loadshã«ä¾å­˜æ€§ãŒã‚ã£ãŸã‚‰ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€åˆ¥ã€…ã®node_modulesã¯å…¨ãåŒã˜lodashãŒã‚ã‚Šã¾ã™ã€‚
- åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒãƒªãƒ¥ãƒ¼ãŒå…±æœ‰ã§ããªã„ã§ã™ã€‚ä¾‹ãˆã°ã€é•ã†å ´æ‰€ã®Reactã‚’å¼•ç”¨ã—ãŸã‚‰é•ã†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãªã‚‹ã®ã§ã€å…±æœ‰ã™ã¹ãå†…éƒ¨ã®å¤‰æ•°ã¯å…±æœ‰ã§ããªã„ã§ã™ã€‚

### npm3/yarn - ãƒ•ãƒ©ãƒƒãƒˆã®node_modules

npm3ã‹ã‚‰ï¼ˆyarnã‚‚åŒã˜) flat node_modulesã‚’æ¡ç”¨ã•ã‚Œã¦ã€ä»Šã¾ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚nodejsã®[ä¾å­˜æ€§è§£æ](https://nodejs.org/api/modules.html#all-together)ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«node_modulesã§è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€å†å¸°çš„ã«è¦ªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®node_modulesã«è§£æã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒã‚ã£ã¦ã€ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦å…¨ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã®node_modulesã«ãŠã„ã¦ã€å…±æœ‰ã§ããªã„ã‚‚ã®ã¨ä¾å­˜ãƒ‘ã‚¹ãŒé•·ã™ãã‚‹å•é¡Œã‚’è§£æ±ºã§ãã¾ã—ãŸã€‚

ä¸Šè¨˜ã®ä¾‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã‚Šã¾ã™ã€‚

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ bar
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json
```

ã“ã‚Œã‚‚expressã ã‘ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€node_modulesã«50ãã‚‰ã„ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã§ãã¦ã—ã¾ã†åŸå› ã§ã™ã€‚
ãŸã ã€æ–°ãŸãªèª²é¡ŒãŒå‡ºã¦ãã¾ã™ã€‚


1. package.jsonã«æ›¸ã„ã¦ã„ãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹([Phantom](https://rushjs.io/pages/advanced/phantom_deps/)ãƒ»å¹»å½±)ã€‚
2. node_modulesã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ä¸ç¢ºå®šæ€§ï¼ˆ[Doppelgangers](https://rushjs.io/pages/advanced/npm_doppelgangers/)ãƒ»è‡ªåˆ†è‡ªèº«ã®å§¿ã‚’è‡ªåˆ†ã§è¦‹ã‚‹å¹»è¦šï¼‰ã€‚
3. flat node_modulesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è‡ªä½“ãŒè¤‡é›‘ã§ã€æ™‚é–“ã‹ã‹ã‚‹ã€‚

#### Phantom

barã«ä¾å­˜æ€§ãŒã‚ã‚‹fooã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€barã‚‚node_modulesã®é…ä¸‹ãªã®ã§ã€ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
ä»®ã«ä¸æ³¨æ„ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ã‚ã‚ŒãŸã¨ã—ãŸã‚‰ã€ã„ã¤ã‹fooã¯barã‚’ä½¿ã‚ãªããªã£ãŸã‚Šã€barã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸã‚Šã™ã‚‹ã¨ã—ãŸã‚‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã§å¼•ç”¨ã—ã¦ã„ã‚‹barã®çŠ¶æ…‹ãŒå¤‰ã‚ã£ã¦äºˆæœŸã§ããªã„ã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### Doppelgangers

Doppelgangersã¯å°‘ã—è¤‡é›‘ã«ãªã‚‹ã®ã§ã€ä¸Šè¨˜ã®ä¾‹ã‹ã‚‰fooã¯lodash@1.0.0ä¾å­˜ã€barã¯lodash@1.0.1ä¾å­˜
```
foo - lodash@1.0.0
bar - lodash@1.0.1
```
ã«ã—ãŸã‚‰ã€nodejsã®[ä¾å­˜æ€§è§£æ](https://nodejs.org/api/modules.html#all-together)ãƒ«ãƒ¼ãƒ«ã§ã¯ã€require(PACKAGE_NAME)ã®PACKAGE_NAMEã¯node_modulesé…ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¨åŒã˜å¿…è¦ã€ã¨ã„ã†ã®ã¯PACKAGE_NAMEï¼ VERSIONã¯ã§ããªã„ã§ã™ã€‚ãã†ã—ãŸã‚‰ã€æ§‹é€ ã¯

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â”œâ”€â”€ bar
    â”‚   â”œâ”€â”€ index.js
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ lodash
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json(@1.0.1)
    â””â”€â”€ lodash
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json(@1.0.0)
```
ã¨
```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ lodash
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json(@1.0.0)
    â”œâ”€â”€ bar
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ lodash
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json(@1.0.1)
```

ã©ã¡ã‚‰ã«ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

çµæœã¯ã©ã¡ã‚‰ã‚‚å¯èƒ½ã§ã™ãƒ»ãƒ»ãƒ»

package.jsonã§ã®ä½ç½®ã§æ±ºã¾ã‚Šã¾ã™ã€‚fooãŒä¸Šãªã‚‰ã€ä¸Šã®æ§‹é€ ã€ã˜ã‚ƒãªã‘ã‚Œã°ä¸‹ã®æ§‹é€ ã€‚ã“ã®ã‚ˆã†ãªä¸ç¢ºå®šæ€§ã¯Doppelgangersã¨è¨€ã„ã¾ã™ã€‚


### npm5.x/yarn - ãƒ•ãƒ©ãƒƒãƒˆã®node_modulesã¨lock file

node_modulesã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ä¸ç¢ºå®šæ€§ã®è§£æ±ºãŸã‚ã€lockãƒ•ã‚¡ã‚¤ãƒ«ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚ãã†ã™ã‚Œã°ã€ä½•å›ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ã€åŒã˜ã‚ˆã†ãªæ§‹é€ ã«ãªã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚‚lockãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«å…¥ã‚Œã¦ã€æ‰‹å‹•ã§ç·¨é›†ã—ãªã„ç†ç”±ã§ã™ã€‚

ãŸã ã—ã€flatã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è¤‡é›‘ã•ã€ã¨Phantomã‚¢ã‚¯ã‚»ã‚¹ã€æ€§èƒ½ã¨å®‰å…¨ã®å•é¡Œã¯æœªè§£æ±ºã§ã™ã€‚


### pnpm - ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã«åŸºã¥ãnode_modulesæ§‹é€ 

ã“ã®éƒ¨åˆ†ã¯è¤‡é›‘ã§å…¬å¼ã‚µã‚¤ãƒˆã§ã®[èª¬æ˜](https://pnpm.io/symlinked-node-modules-structure)ã¯ä¸€ç•ªè‰¯ã„æ°—ãŒã—ã¾ã™ãŒã€ã“ã‚Œã«åŸºã¥ã„ã¦èª¬æ˜ã—ã¦ã¿ã¾ã™ã€‚

node_modulesãŒç”Ÿæˆã™ã‚‹ã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—å¤§ãã2ã¤ã‚ã‚Šã¾ã™ã€‚

#### ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ§‹é€ 

```
.
â””â”€â”€ node_modules
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â””â”€â”€ foo -> <store>/foo
        â””â”€â”€ bar@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ bar -> <store>/bar
```
ä¸€è¦‹ä»–ã®æ§‹é€ ã¨å…¨ãé•ã£ã¦ã€æœ€åˆã®node_modulesã®é…ä¸‹ã¯.pnpmã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã—ã‹ãªã„ã§ã™ã€‚.pnpmã®é…ä¸‹ã¯<ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³>ãƒ•ã‚©ãƒ«ãƒ€ãŒã§ãã¦ã€ãã®é…ä¸‹ã®<ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å>ãƒ•ã‚©ãƒ«ãƒ€ã¯storeã®ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã§ã™ã€‚ã“ã‚Œã ã‘ã§å‹•ã‹ãªã„ã®ã§ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å¤§äº‹ã§ã™ã€‚

#### ä¾é ¼è§£æç”¨ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯

- fooå†…ã«barã‚’å¼•ç”¨ã™ã‚‹ãŸã‚ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰fooã‚’å¼•ç”¨ã™ã‚‹ãŸã‚ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯


```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ foo -> <store>/foo
        â”‚       â””â”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
        â””â”€â”€ bar@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ bar -> <store>/bar
```

ã“ã‚Œã§æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªpnpm node_modulesã®æ§‹é€ ã«ãªã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã¯package.jsonã«ã‚ã‚‹ã‚‚ã®ã—ã‹å¼•ç”¨ã§ããªã„ã“ã¨ã¨ã€ç„¡é§„ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œå…¨ã«ãªã—ã§ã§ãã¾ã™ã€‚[peers dependencies](https://pnpm.io/how-peers-are-resolved)ã¯å°‘ã—è¤‡é›‘ã«ãªã‚Šã¾ã™ãŒã€peerä»¥å¤–ã¯å…¨éƒ¨ã“ã®ã‚ˆã†ãªæ§‹é€ ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€fooã¨barã¯åŒæ™‚ã«lodashã‚’ä¾å­˜ã¨ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã‚Šã¾ã™ã€‚

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ foo -> <store>/foo
        â”‚       â”œâ”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
        â”‚       â””â”€â”€ lodash -> ../../lodash@1.0.0/node_modules/lodash
        â”œâ”€â”€ bar@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ bar -> <store>/bar
        â”‚       â””â”€â”€ lodash -> ../../lodash@1.0.0/node_modules/lodash
        â””â”€â”€ lodash@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ lodash -> <store>/lodash
```

ã“ã‚Œã§ã€ã©ã®ã‚ˆã†ãªè¤‡é›‘ã®ä¾å­˜æ€§ã§ã‚‚ã“ã®æ·±ã•ã®ãƒ‘ã‚¹ã§å®Œçµã¯å¯èƒ½ã¨ãªã£ã¦ã€é©æ–°çš„ãªnode_modulesæ§‹é€ ã§ã™ã€‚


### pnpmä»¥å¤–ã®è§£æ±ºæ³•

#### npm global-style
npmã‚‚flat node_modulesã®å•é¡Œç‚¹ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€[global-style](https://docs.npmjs.com/cli/v8/using-npm/config#global-style)ã¨ã„ã†è¨­å®šã§flat node_modulesã‚’ç¦æ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€nested node_modulesæ™‚ä»£ã®å•é¡Œã«æˆ»ã£ã¦ã€ã“ã®è§£æ±ºæ³•ã¯åºƒãŒã£ã¦ã„ãªã„ã§ã™ã€‚

#### dependency-check
npm/yarnè‡ªä½“ã§ã€è§£æ±ºã—ã«ãã„ã®ã§ã€[dependency-check](https://github.com/dependency-check-team/dependency-check)ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

```
$ dependency-check ./package.json --verbose
Success! All dependencies used in the code are listed in package.json
Success! All dependencies in package.json are used in the code
```
å…¬å¼READMEã®ä¸€éƒ¨ã‚’è¦‹ãŸã‚‰ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å¤§ä½“ã‚ã‹ã£ã¦ãã‚‹ã§ã—ã‚‡ã†ã‹ã€‚

ä»–ã®è§£æ±ºæ³•ã¨æ¯”ã¹ã¦ã€pnpmã¯ã‚„ã£ã±ã‚Šä¸€ç•ªã‚¹ãƒƒã‚­ãƒªã—ã¾ã™ã­ï¼

## æœ€å¾Œã«

### åŸºæœ¬ã®ã‚³ãƒãƒ³ãƒ‰
ä¸Šè¨˜ã®èª¬æ˜ã§pnpmã¯éå¸¸ã«è¤‡é›‘ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€å®Ÿã¯å…¨ãé•ã„ã¾ã™ï¼
npm/yarnã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚‹äººã¯ã€ã»ã¼å‹‰å¼·ã‚³ã‚¹ãƒˆãªã—ã§pnpmãŒä½¿ãˆã¾ã™ã€‚ã„ãã¤ä¾‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```shell
pnpm install express
pnpm update express
pnpm remove express
```
ã»ã¼çŸ¥ã£ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¨å¤‰ã‚ã‚‰ãªã„ã§ã™ã­ï¼

### ãƒ¢ãƒãƒªãƒã‚µãƒãƒ¼ãƒˆ

pnpmã¯ãƒ¢ãƒãƒªãƒã‚‚ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚ä½œè€…ã¯[lernaã¨ã®æ¯”è¼ƒã®æ–‡ç« ](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)ã‚‚ã‚ã‚Šã¾ã™ã€‚è©³ç´°ã‚’èª¬æ˜ã™ã‚‹ã¨ã€é•·ããªã‚‹ã®ã§ã€ã“ã“ã¯ä¸€ä¾‹ã ã‘ç´¹ä»‹ã•ã›ã¾ã™ã€‚

```shell
pnpm --parallel  run --recursive  --filter apps test
```
ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€éåŒæœŸã§appsé…ä¸‹ã®workspaceã§ã®npm script testã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚å…ƒã€…lernaã¨ã‹ãƒ¢ãƒãƒªãƒç®¡ç†ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼å¿…è¦ãªã‚·ãƒ¼ãƒ³ã‚‚pnpmã ã‘å®Œçµå¯èƒ½ã§ã™ã€‚

---

*Originally published at [https://engineering.meetsmore.com](https://engineering.meetsmore.com/entry/2021/12/06/112931) on December 6, 2021.*